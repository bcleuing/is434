<!DOCTYPE html>
<html>
<head>
    <title>IS434 - Vaniday Fans Analysis (Charts Visualization)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">
    <link rel="stylesheet" href="resources/css/style.css" />
</head>
<body>

    <div class="container">
        <div class="row center">
            <div class="col s12" id="pagesFanInfoTable">
                <h3 class="header">Fan Statistics (Table)</h3>
            </div>
        </div>

        <div class="divider"></div>

        <div class="row center">
            <div class="col s12" id="pagesFanInfoCharts">
                <h3 class="header">Fan Statistics (Charts)</h3>
            </div>
        </div>
    </div>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
    <script src="resources/js/vaniday-fans-analysis.js"></script>
    <script>
        $(function() {
            $.ajax({
                url: "resources/data/lifetime-likes-by-gender-and-age.csv",
                type: "GET",
                dataType: "text",
                success: function(data) {
                    processData(data);
                }
            })
        });

        function processData(allText) {
            var allTextLines = allText.split(/\r\n|\n/);
            var headers = allTextLines[0].split(',');
            headers.shift(); // remove the date column
            var headersLength = headers.length;

            var jsonData = {};
            for (var i = 0; i < headersLength; i++) {
                // initialize the JSON object
                jsonData[headers[i]] = 0;
            }

            var lines = [];
            for (i = 1; i < allTextLines.length; i++) {
                var data = allTextLines[i].split(',');
                data.shift(); // remove the date record
                if (data.length == headersLength) {
                    for (var j = 0; j < headersLength; j++) {
                        jsonData[headers[j]] = data[j];
                    }
                    lines.push(jsonData);
                }
            }

            var stat = lines[lines.length-1].value; // get the latest statistic
            var formattedStat = {
                "Female": [0,0,0,0,0,0,0],
                "Male": [0,0,0,0,0,0,0],
                "Unknown": [0,0,0,0,0,0,0],
            }; // declare an object to store the number of fans by gender by age groups
            var totalFans = [0,0,0,0,0,0,0]; // total numbers of fans by age groups

            for (var key in stat) {
                if (stat.hasOwnProperty(key)) {
                    var gender = getFullGender(key.split(".")[0]);
                    var ageGroup = key.split(".")[1];
                    var numOfFans = stat[key];
                    var ageGroupIdx = ageGroupLabels.indexOf(ageGroup);
                    formattedStat[gender][ageGroupIdx] = numOfFans; // by gender by age group
                    totalFans[ageGroupIdx] += numOfFans; // by age group
                }
            }

            renderTables(formattedStat);
            renderCharts(formattedStat, totalFans);
        }
    </script>

</body>
</html>
